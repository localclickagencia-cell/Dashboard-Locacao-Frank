<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard (LIVE) — Locação de Imóveis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{ --bg:#0b1020; --card:#121935; --muted:#8ea2c6; --text:#eef3ff; --accent:#4da3ff; --chip:#1e2a57; --border:#213063; }
    *{box-sizing:border-box} body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#0b1020;margin:0;color:var(--text);}
    header{padding:24px;display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:22px} .chip{background:var(--chip);border:1px solid var(--border);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:12px}
    .filters{display:flex;gap:12px;flex-wrap:wrap;align-items:center} .filters label{font-size:12px;color:var(--muted)}
    .filters input,.filters select{background:var(--chip);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:8px 10px}
    .container{padding:12px 24px 28px} .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:16px;padding:16px;overflow:hidden}
    .kpis{grid-column:1/-1;display:grid;grid-template-columns:repeat(5,1fr);gap:16px}
    .kpi h3{margin:0 0 8px;font-size:12px;color:var(--muted);font-weight:600} .kpi .val{font-size:24px;font-weight:800} .kpi .sub{font-size:12px;color:var(--muted)}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-8{grid-column:span 8}
    .funnel-wrap{width:100%;display:flex;gap:16px;align-items:center} .funnel-legend{display:flex;flex-direction:column;gap:12px;min-width:180px}
    .funnel-legend .row{display:flex;justify-content:space-between;gap:8px;font-size:12px;color:var(--muted)} .funnel-svg{flex:1;border:1px solid var(--border);border-radius:12px;background:var(--chip);}
    .pct-label{font-size:13px;fill:#cfe3ff;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,.3)}
    .table-wrapper{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:420px;background:rgba(0,0,0,.08)}
    .table{width:100%;border-collapse:collapse;font-size:12px;color:var(--text)} .table th,.table td{border-bottom:1px solid var(--border);padding:8px;text-align:right;white-space:nowrap}
    .table th:first-child,.table td:first-child{text-align:left;position:sticky;left:0;background:rgba(10,16,35,.85)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0} .error{color:#ff8888;font-size:12px}
    @media(max-width:1100px){.kpis{grid-template-columns:repeat(2,1fr)}.col-6,.col-8,.col-4{grid-column:1/-1}}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Dashboard (LIVE) — Locação de Imóveis</h1>
      <div class="chip">Sheets publicadas (Tráfego & Comercial)</div>
    </div>
    <div class="filters">
      <label>De <input type="date" id="startDate"></label>
      <label>Até <input type="date" id="endDate"></label>
      <select id="preset">
        <option value="">Período: personalizado</option>
        <option value="7">Últimos 7 dias</option>
        <option value="30">Últimos 30 dias</option>
        <option value="90">Últimos 90 dias</option>
      </select>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card kpis">
        <div class="kpi"><h3>Gasto Total</h3><div class="val" id="kpiGasto">—</div><div class="sub" id="kpiCPM">CPM médio: —</div></div>
        <div class="kpi"><h3>Conversas no WhatsApp</h3><div class="val" id="kpiConversas">—</div><div class="sub" id="kpiCustoConversa">Custo/Conversa: —</div></div>
        <div class="kpi"><h3>Reservas Fechadas</h3><div class="val" id="kpiReservas">—</div><div class="sub" id="kpiCustoReserva">Custo/Reserva: —</div></div>
        <div class="kpi"><h3>Receita Gerada</h3><div class="val" id="kpiReceita">—</div><div class="sub" id="kpiTicketMedio">Ticket médio: —</div></div>
        <div class="kpi"><h3>ROAS</h3><div class="val" id="kpiROAS">—</div><div class="sub" id="kpiTaxas">Cliques→Conversas / Conversas→Reservas</div></div>
      </div>

      <div class="card col-6">
        <h3>Funil de Conversão</h3>
        <div class="funnel-wrap">
          <div class="funnel-legend">
            <div class="row"><span>Impressões</span><span id="lblImp">—</span></div>
            <div class="row"><span>Cliques</span><span id="lblCliques">— <span id="pctImpCliques"></span></span></div>
            <div class="row"><span>Conversas</span><span id="lblConversas">— <span id="pctCliquesConversas"></span></span></div>
            <div class="row"><span>Reservas</span><span id="lblReservas">— <span id="pctConversasReservas"></span></span></div>
          </div>
          <svg id="funnelSVG" class="funnel-svg" viewBox="0 0 800 520" preserveAspectRatio="xMidYMid meet"></svg>
        </div>
      </div>

      <div class="card col-6">
        <h3>Tendência por Dia</h3>
        <canvas id="lineChart" height="140"></canvas>
      </div>

      <div class="card col-8">
        <h3>Eficiência</h3>
        <canvas id="effChart" height="140"></canvas>
      </div>

      <div class="card col-4">
        <h3>Resumo Diário</h3>
        <div class="table-wrapper"><table class="table" id="dataTable"></table></div>
        <div id="error" class="error"></div>
      </div>
    </div>
  </div>

  <script>
    // URLs fixas
    const TRAFEGO_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSORIk5clZR9MB9COpyueD-tG1kwsIaGOJrtiihzOxg31g454Vxru6EcHjWKVq72lcMjDwyR49HkB5u/pub?gid=1952318202&single=true&output=csv";
    const COMERCIAL_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSORIk5clZR9MB9COpyueD-tG1kwsIaGOJrtiihzOxg31g454Vxru6EcHjWKVq72lcMjDwyR49HkB5u/pub?gid=2080509733&single=true&output=csv";

    // Cache-busting + auto-refresh (20 min sempre ativo)
    function cacheBust(url){ const sep = url.includes("?") ? "&" : "?"; return url + sep + "_=" + Date.now(); }
    setInterval(() => loadData(true), 20*60*1000); // 20 minutos

    // Cabeçalhos exatos (conforme sua planilha)
    const H = {
      T: {
        data: ['Data'], impressoes: ['Impressões'], alcance: ['Alcance'], frequencia: ['Frequência'],
        gasto: ['Valor Gasto (R$)'], cpm: ['CPM (R$)'], ctr: ['CTR (%)'], cpc: ['CPC (R$)'],
        cliques: ['Cliques no Link'], conversas: ['Conversas no WhatsApp'], custo_conversa: ['Custo por Conversa (R$)']
      },
      C: { data: ['Data'], reservas: ['Reservas Fechadas'], receita: ['Receita Gerada (R$)'] }
    };

    const fmtMoney = v => v?.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) ?? '—';
    const fmtNum = v => (v ?? 0).toLocaleString('pt-BR');
    const fmtPct = v => (v ?? 0).toLocaleString('pt-BR', {maximumFractionDigits:2}) + '%';

    const parseNum = (x) => { 
      if (x===null || x===undefined || x==='') return 0;
      const s=(''+x).trim();
      const cleaned = s.replace(/R\$|\s/g,'').replace(/\./g,'').replace(',','.');
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    };

    function toDateISO(s){
      if(!s) return null;
      const str=(''+s).trim();
      const m = str.match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})/);
      if (m){ const d=m[1].padStart(2,'0'), mo=m[2].padStart(2,'0'), y=m[3].length===2? ('20'+m[3]): m[3]; return `${y}-${mo}-${d}`; }
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      const d=new Date(str); if(!isNaN(d)) return d.toISOString().slice(0,10);
      return null;
    }

    function headerOf(headers, aliases){
      return aliases.find(a => headers.some(h => h && h.trim().toLowerCase()===a.trim().toLowerCase())) || null;
    }

    function fetchCSV(url){
      return new Promise((resolve, reject) => {
        Papa.parse(cacheBust(url), { download: true, header: true, complete: r => resolve(r), error: err => reject(err) });
      });
    }

    function normalizeTrafego(rows, headers){
      const map = {
        data: headerOf(headers, H.T.data), impressoes: headerOf(headers, H.T.impressoes),
        alcance: headerOf(headers, H.T.alcance), frequencia: headerOf(headers, H.T.frequencia),
        gasto: headerOf(headers, H.T.gasto), cpm: headerOf(headers, H.T.cpm),
        ctr: headerOf(headers, H.T.ctr), cpc: headerOf(headers, H.T.cpc),
        cliques: headerOf(headers, H.T.cliques), conversas: headerOf(headers, H.T.conversas),
        custo_conversa: headerOf(headers, H.T.custo_conversa)
      };
      return rows.map(r => ({ data: toDateISO(r[map.data]), impressoes: parseNum(r[map.impressoes]), alcance: parseNum(r[map.alcance]),
        frequencia: parseNum(r[map.frequencia]), gasto: parseNum(r[map.gasto]), cpm: parseNum(r[map.cpm]),
        ctr: parseNum(r[map.ctr]), cpc: parseNum(r[map.cpc]), cliques: parseNum(r[map.cliques]),
        conversas: parseNum(r[map.conversas]), custo_conversa: parseNum(r[map.custo_conversa]) })).filter(r=>r.data);
    }

    function normalizeComercial(rows, headers){
      const map = { data: headerOf(headers, H.C.data), reservas: headerOf(headers, H.C.reservas), receita: headerOf(headers, H.C.receita) };
      return rows.map(r => ({ data: toDateISO(r[map.data]), reservas: parseNum(r[map.reservas]), receita: parseNum(r[map.receita]) })).filter(r=>r.data);
    }

    function joinByDate(trafego, comercial){
      const map = new Map();
      trafego.forEach(t => { if(!t.data) return; map.set(t.data, {...t}); });
      comercial.forEach(c => { if(!c.data) return;
        if(map.has(c.data)) map.set(c.data, {...map.get(c.data), ...c});
        else map.set(c.data, {...c});
      });
      const rows = Array.from(map.values()).filter(r=>r.data).sort((a,b)=> a.data.localeCompare(b.data)).map(r => {
        const spend=r.gasto||0, clicks=r.cliques||0, chats=r.conversas||0, reservas=r.reservas||0, receita=r.receita||0, imp=r.impressoes||0;
        const custoConversa = chats? (spend/chats): 0;
        const custoReserva = reservas? (spend/reservas): 0;
        const roas = spend? (receita/spend): 0;
        const ticketMedio = reservas? (receita/reservas): 0;
        const taxa1 = clicks? (chats/clicks)*100 : 0;
        const taxa2 = chats? (reservas/chats)*100 : 0;
        const ctr_calc = imp? (clicks/imp)*100 : 0;
        return { ...r, custo_conversa: custoConversa, custo_reserva: custoReserva, roas, ticket_medio: ticketMedio, taxa_clicks_conversas: taxa1, taxa_conversas_reservas: taxa2, ctr: ctr_calc };
      });
      return rows;
    }

    let DATA=[];

    async function loadData(isAuto=false){
      const error = document.getElementById('error'); error.textContent='';
      try{
        const [tRes, cRes] = await Promise.all([fetchCSV(TRAFEGO_CSV_URL), fetchCSV(COMERCIAL_CSV_URL)]);
        const tHeaders = (tRes.meta.fields||[]).filter(Boolean);
        const cHeaders = (cRes.meta.fields||[]).filter(Boolean);
        const trafego = normalizeTrafego(tRes.data||[], tHeaders);
        const comercial = normalizeComercial(cRes.data||[], cHeaders);
        DATA = joinByDate(trafego, comercial);
        if(!DATA.length){ error.textContent = 'Nenhum dado carregado. Verifique filtros, nomes de colunas e publicação do CSV.'; return; }
        if(!isAuto) initDates(DATA);
        renderAll();
      }catch(e){ error.textContent = 'Erro ao carregar dados: ' + (e?.message||e); }
    }

    function initDates(rows){ if (!rows.length) return; const min = new Date(rows[0].data); const max = new Date(rows[rows.length-1].data); const fmt = d => d.toISOString().slice(0,10); document.getElementById('startDate').value = fmt(min); document.getElementById('endDate').value = fmt(max); }

    function aggregate(rows){
      const agg = rows.reduce((a,r)=>({ imp:a.imp+(r.impressoes||0), alc:a.alc+(r.alcance||0), spend:a.spend+(r.gasto||0),
        clicks:a.clicks+(r.cliques||0), chat:a.chat+(r.conversas||0), res:a.res+(r.reservas||0),
        rev:a.rev+(r.receita||0), cpm_sum:a.cpm_sum+(r.cpm||0), days:a.days+1 } ),{imp:0,alc:0,spend:0,clicks:0,chat:0,res:0,rev:0,cpm_sum:0,days:0});
      const cpmMedio = agg.days ? agg.cpm_sum/agg.days : 0;
      const custoConversa = agg.chat ? agg.spend/agg.chat : 0;
      const custoReserva = agg.res ? agg.spend/agg.res : 0;
      const ticketMedio = agg.res ? agg.rev/agg.res : 0;
      const roas = agg.spend ? agg.rev/agg.spend : 0;
      const ctr = agg.imp ? (agg.clicks/agg.imp)*100 : 0;
      const taxa1 = agg.clicks ? (agg.chat/agg.clicks)*100 : 0;
      const taxa2 = agg.chat ? (agg.res/agg.chat)*100 : 0;
      return {...agg, cpmMedio, custoConversa, custoReserva, ticketMedio, roas, ctr, taxa1, taxa2};
    }

    function drawFunnel({imp, clicks, chat, res, ctr, taxa1, taxa2}){
      const svg = document.getElementById('funnelSVG'); svg.innerHTML='';
      const width=800, height=520, padding=20;
      const steps=[{label:'Impressões',value:imp},{label:'Cliques',value:clicks},{label:'Conversas',value:chat},{label:'Reservas',value:res}];
      const max=Math.max(...steps.map(s=>s.value),1);
      const bandH=(height-padding*2)/steps.length;
      let y=padding;
      steps.forEach((s,i)=>{
        const topW=(i===0)? width-padding*2 : ((steps[i-1].value/max)*(width-padding*2));
        const botW=(s.value/max)*(width-padding*2);
        const xCenter=width/2;
        const points=[[xCenter-topW/2,y],[xCenter+topW/2,y],[xCenter+botW/2,y+bandH-10],[xCenter-botW/2,y+bandH-10]].map(p=>p.join(',')).join(' ');
        const poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
        poly.setAttribute('points',points);
        poly.setAttribute('fill',`url(#grad${i})`);
        poly.setAttribute('stroke','rgba(255,255,255,0.15)');
        poly.setAttribute('stroke-width','1');
        svg.appendChild(poly);
        const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x',xCenter); txt.setAttribute('y',y+bandH/2);
        txt.setAttribute('text-anchor','middle'); txt.setAttribute('dominant-baseline','middle');
        txt.setAttribute('font-size','14'); txt.setAttribute('fill','#eef3ff');
        txt.textContent=s.label+': '+(s.value||0).toLocaleString('pt-BR');
        svg.appendChild(txt);
        if(i>0){
          const pctVal = i===1 ? ctr : (i===2 ? taxa1 : taxa2);
          const pctTxt=document.createElementNS('http://www.w3.org/2000/svg','text');
          pctTxt.setAttribute('x', xCenter + (width*0.35)); pctTxt.setAttribute('y', y - 6);
          pctTxt.setAttribute('text-anchor','middle'); pctTxt.setAttribute('class','pct-label');
          const label = i===1 ? 'Impressões → Cliques' : i===2 ? 'Cliques → Conversas' : 'Conversas → Reservas';
          pctTxt.textContent = label + ': ' + (pctVal||0).toLocaleString('pt-BR', {maximumFractionDigits:2}) + '%';
          svg.appendChild(pctTxt);
        }
        y+=bandH;
      });
      const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
      steps.forEach((_,i)=>{ const lg=document.createElementNS('http://www.w3.org/2000/svg','linearGradient'); lg.setAttribute('id','grad'+i); lg.setAttribute('x1','0%'); lg.setAttribute('y1','0%'); lg.setAttribute('x2','0%'); lg.setAttribute('y2','100%'); const s1=document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','rgba(77,163,255,0.95)'); const s2=document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','rgba(77,163,255,0.55)'); lg.appendChild(s1); lg.appendChild(s2); defs.appendChild(lg); });
      svg.insertBefore(defs, svg.firstChild);
    }

    function renderKPIs(rows){
      const a=aggregate(rows);
      document.getElementById('kpiGasto').textContent=fmtMoney(a.spend);
      document.getElementById('kpiCPM').textContent='CPM médio: '+fmtMoney(a.cpmMedio);
      document.getElementById('kpiConversas').textContent=fmtNum(a.chat);
      document.getElementById('kpiCustoConversa').textContent='Custo/Conversa: '+fmtMoney(a.custoConversa);
      document.getElementById('kpiReservas').textContent=fmtNum(a.res);
      document.getElementById('kpiCustoReserva').textContent='Custo/Reserva: '+fmtMoney(a.custoReserva);
      document.getElementById('kpiReceita').textContent=fmtMoney(a.rev);
      document.getElementById('kpiTicketMedio').textContent='Ticket médio: '+fmtMoney(a.ticketMedio);
      document.getElementById('kpiROAS').textContent=(a.roas||0).toLocaleString('pt-BR', {maximumFractionDigits:2});
      document.getElementById('kpiTaxas').textContent=fmtPct(a.taxa1)+' / '+fmtPct(a.taxa2);
      document.getElementById('lblImp').textContent=fmtNum(a.imp);
      document.getElementById('lblCliques').childNodes[0].nodeValue = fmtNum(a.clicks)+' ';
      document.getElementById('lblConversas').childNodes[0].nodeValue = fmtNum(a.chat)+' ';
      document.getElementById('lblReservas').childNodes[0].nodeValue = fmtNum(a.res)+' ';
      document.getElementById('pctImpCliques').textContent='('+ (a.ctr||0).toLocaleString('pt-BR', {maximumFractionDigits:2}) +'%)';
      document.getElementById('pctCliquesConversas').textContent='('+ (a.taxa1||0).toLocaleString('pt-BR', {maximumFractionDigits:2}) +'%)';
      document.getElementById('pctConversasReservas').textContent='('+ (a.taxa2||0).toLocaleString('pt-BR', {maximumFractionDigits:2}) +'%)';
      drawFunnel({imp:a.imp, clicks:a.clicks, chat:a.chat, res:a.res, ctr:a.ctr, taxa1:a.taxa1, taxa2:a.taxa2});
    }

    let lineChart, effChart;
    function renderCharts(rows){
      if (lineChart) lineChart.destroy(); if (effChart) effChart.destroy();
      const labels=rows.map(r=>r.data);
      const gastos=rows.map(r=>r.gasto);
      const conversas=rows.map(r=>r.conversas);
      const reservas=rows.map(r=>r.reservas);
      const receita=rows.map(r=>r.receita);
      const ctx1=document.getElementById('lineChart').getContext('2d');
      lineChart=new Chart(ctx1,{ type:'line', data:{ labels, datasets:[ {label:'Gasto (R$)', data:gastos}, {label:'Conversas', data:conversas}, {label:'Reservas', data:reservas}, {label:'Receita (R$)', data:receita} ]}, options:{ responsive:true, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}}} });
      const ctx2=document.getElementById('effChart').getContext('2d');
      const custoConversa=rows.map(r=>r.conversas? (r.gasto/r.conversas):0);
      const custoReserva=rows.map(r=>r.reservas? (r.gasto/r.reservas):0);
      effChart=new Chart(ctx2,{ type:'line', data:{ labels, datasets:[ {label:'Custo por Conversa (R$)', data:custoConversa}, {label:'Custo por Reserva (R$)', data:custoReserva} ]}, options:{ responsive:true, plugins:{legend:{position:'bottom'}}, scales:{y:{beginAtZero:true}}} });
    }

    let compact=true;
    function renderTable(rows){
      const table=document.getElementById('dataTable');
      const colsCompact=['data','gasto','cliques','conversas','reservas','receita','roas'];
      const colsFull=['data','impressoes','alcance','frequencia','gasto','cpm','ctr','cpc','cliques','conversas','custo_conversa','reservas','custo_reserva','receita','ticket_medio','roas','taxa_clicks_conversas','taxa_conversas_reservas'];
      const cols=compact? colsCompact: colsFull;
      const headers={ data:'Data', impressoes:'Impressões', alcance:'Alcance', frequencia:'Frequência', gasto:'Gasto (R$)', cpm:'CPM (R$)', ctr:'CTR (%)', cpc:'CPC (R$)', cliques:'Cliques', conversas:'Conversas', custo_conversa:'Custo/Conv (R$)', reservas:'Reservas', custo_reserva:'Custo/Res (R$)', receita:'Receita (R$)', ticket_medio:'Ticket Médio (R$)', roas:'ROAS', taxa_clicks_conversas:'Cliques→Conversas (%)', taxa_conversas_reservas:'Conversas→Reservas (%)' };
      let html='<thead><tr>'+cols.map(c=>'<th>'+headers[c]+'</th>').join('')+'</tr></thead><tbody>';
      rows.forEach(r=>{ html+='<tr>'; cols.forEach(c=>{ let v=r[c];
        if(['gasto','cpm','cpc','custo_conversa','custo_reserva','receita','ticket_medio'].includes(c)) v=fmtMoney(v);
        else if(['roas'].includes(c)) v=(v||0).toLocaleString('pt-BR', {maximumFractionDigits:2});
        else if(['ctr','taxa_clicks_conversas','taxa_conversas_reservas'].includes(c)) v=fmtPct(v);
        else if(['frequencia'].includes(c)) v=(v||0).toLocaleString('pt-BR', {maximumFractionDigits:2});
        else if(['impressoes','alcance','cliques','conversas','reservas'].includes(c)) v=fmtNum(v);
        html+='<td>'+(v ?? '—')+'</td>'; }); html+='</tr>'; });
      html+='</tbody>'; table.innerHTML=html;
    }

    function filterByDate(data){ const s=document.getElementById('startDate').value; const e=document.getElementById('endDate').value; return data.filter(d=>{ const dt=new Date(d.data); if (s && dt < new Date(s)) return false; if (e && dt > new Date(e)) return false; return true; }); }
    function renderAll(){ const rows=filterByDate(DATA); renderKPIs(rows); renderCharts(rows); renderTable(rows); }

    document.getElementById('startDate').addEventListener('change', renderAll);
    document.getElementById('endDate').addEventListener('change', renderAll);
    document.getElementById('preset').addEventListener('change', (e)=>{ const days=parseInt(e.target.value||'0',10); if (!days||!DATA.length) return; const max=new Date(DATA[DATA.length-1].data); const min=new Date(max); min.setDate(min.getDate()-days+1); const fmt=d=>d.toISOString().slice(0,10); document.getElementById('startDate').value=fmt(min); document.getElementById('endDate').value=fmt(max); renderAll(); });

    // primeira carga
    loadData();
  </script>
</body>
</html>
